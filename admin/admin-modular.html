<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç«™ç®¡ç†ä¸­å¿ƒ - æ¨¡å—åŒ–ç‰ˆæœ¬</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- æ¨¡å—åŒ–æ ·å¼ -->
    <link rel="stylesheet" href="styles/core.css">
    <link rel="stylesheet" href="styles/forms.css">
    <link rel="stylesheet" href="styles/collapsible.css">
    
    <!-- æ¨¡å—åŠ è½½å™¨ -->
    <script src="../js/admin/loader.js"></script>
</head>
<body>
    <div class="admin-container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="admin-header">
            <div class="admin-header-content">
                <h1><i class="fas fa-shield-alt"></i> ç½‘ç«™ç®¡ç†ä¸­å¿ƒ</h1>
                <div class="admin-status">
                    <span class="status-indicator" id="connection-status">
                        <i class="fas fa-circle"></i> æ­£åœ¨è¿æ¥...
                    </span>
                    <span class="user-info">
                        ç”¨æˆ·: <span id="current-user">æœªç™»å½•</span>
                    </span>
                    <button class="btn btn-secondary" onclick="logout()" style="display: none;" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> é€€å‡º
                    </button>
                </div>
            </div>
        </div>

        <!-- ç™»å½•ç•Œé¢ -->
        <div id="auth-section" class="auth-section">
            <div class="auth-card">
                <h2><i class="fas fa-lock"></i> ç®¡ç†å‘˜ç™»å½•</h2>
                <div id="auth-messages" class="messages"></div>
                
                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                
                <div class="form-group">
                    <label>å¯†ç </label>
                    <div class="password-input-container">
                        <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
                        <button type="button" class="password-toggle" onclick="togglePassword()">
                            <i class="fas fa-eye" id="password-toggle-icon"></i>
                        </button>
                    </div>
                </div>
                
                <button onclick="authenticate()" class="btn btn-primary btn-full">
                    <i class="fas fa-sign-in-alt"></i> ç™»å½•ç®¡ç†åå°
                </button>
                
                <div style="text-align: center; margin-top: 15px;">
                    <button onclick="window.open('diagnostic.html', '_blank')" class="btn btn-secondary" style="font-size: 0.85rem; padding: 8px 16px; margin: 3px;">
                        <i class="fas fa-stethoscope"></i> ç³»ç»Ÿè¯Šæ–­
                    </button>
                    <button onclick="window.open('env-setup-guide.html', '_blank')" class="btn btn-secondary" style="font-size: 0.85rem; padding: 8px 16px; margin: 3px;">
                        <i class="fas fa-cog"></i> ç¯å¢ƒé…ç½®
                    </button>
                    <button onclick="window.open('functions-deployment-check.html', '_blank')" class="btn btn-secondary" style="font-size: 0.85rem; padding: 8px 16px; margin: 3px; background: #dc3545;">
                        <i class="fas fa-exclamation-triangle"></i> éƒ¨ç½²æ£€æŸ¥
                    </button>
                    <button onclick="window.open('PROBLEM-SOLVED.html', '_blank')" class="btn btn-secondary" style="font-size: 0.85rem; padding: 8px 16px; margin: 3px; background: #28a745;">
                        <i class="fas fa-check-circle"></i> ä¿®å¤æ–¹æ¡ˆ
                    </button>
                </div>
                
                <div class="security-notice">
                    <h4><i class="fas fa-shield-alt"></i> å®‰å…¨æç¤º</h4>
                    <p>è¯·ä½¿ç”¨æ‚¨åœ¨ EdgeOne Pages ç¯å¢ƒå˜é‡ä¸­é…ç½®çš„ç®¡ç†å‘˜å‡­æ®ç™»å½•ã€‚</p>
                </div>
            </div>
        </div>

        <!-- ä¸»å·¥ä½œåŒº -->
        <div id="main-workspace" class="main-workspace" style="display: none;">
            <!-- å¯¼èˆªèœå• -->
            <div class="nav-menu">
                <h3><i class="fas fa-cog"></i> é…ç½®ç®¡ç†</h3>
                <ul class="config-list">
                    <li><button class="config-btn" data-config="index">
                        <i class="fas fa-home"></i> é¦–é¡µé…ç½®
                    </button></li>
                    <li><button class="config-btn" data-config="products">
                        <i class="fas fa-box"></i> äº§å“é…ç½®
                    </button></li>
                    <li><button class="config-btn" data-config="services">
                        <i class="fas fa-tools"></i> æœåŠ¡é…ç½®
                    </button></li>
                    <li><button class="config-btn" data-config="partners">
                        <i class="fas fa-handshake"></i> åˆä½œä¼™ä¼´é…ç½®
                    </button></li>
                    <li><button class="config-btn" data-config="about">
                        <i class="fas fa-info-circle"></i> å…³äºæˆ‘ä»¬é…ç½®
                    </button></li>
                    <li><button class="config-btn" data-config="contact">
                        <i class="fas fa-phone"></i> è”ç³»æˆ‘ä»¬é…ç½®
                    </button></li>
                    <li><button class="config-btn" data-config="footer">
                        <i class="fas fa-anchor"></i> é¡µè„šé…ç½®
                    </button></li>
                </ul>
            </div>

            <!-- ç¼–è¾‘å™¨åŒºåŸŸ -->
            <div class="editor-area">
                <div class="editor-header">
                    <h3 id="current-config-title">
                        <i class="fas fa-file"></i> é€‰æ‹©è¦ç¼–è¾‘çš„é…ç½®
                    </h3>
                    <div class="editor-actions">
                        <button class="btn btn-success" onclick="saveConfig()" id="save-btn" disabled>
                            <i class="fas fa-save"></i> ä¿å­˜é…ç½®
                        </button>
                        <button class="btn btn-secondary" onclick="reloadConfig()" id="reload-btn" disabled>
                            <i class="fas fa-redo"></i> é‡æ–°åŠ è½½
                        </button>
                    </div>
                </div>

                <div id="editor-messages" class="messages"></div>

                <div class="editor-content">
                    <form id="config-form">
                        <div id="form-container">
                            <div class="welcome-message">
                                <h4><i class="fas fa-rocket"></i> æ¬¢è¿ä½¿ç”¨æ¨¡å—åŒ–ç®¡ç†ä¸­å¿ƒ</h4>
                                <p>è¿™æ˜¯æ–°çš„æ¨¡å—åŒ–ç‰ˆæœ¬ï¼Œå…·æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š</p>
                                <ul>
                                    <li>ğŸ“¦ <strong>æ¨¡å—åŒ–æ¶æ„</strong>ï¼šæ–‡ä»¶æŒ‰åŠŸèƒ½æ‹†åˆ†ï¼Œä¾¿äºç»´æŠ¤</li>
                                    <li>ğŸš€ <strong>æŒ‰éœ€åŠ è½½</strong>ï¼šåªåŠ è½½å¿…è¦çš„æ¨¡å—ï¼Œæå‡æ€§èƒ½</li>
                                    <li>ğŸ”§ <strong>æ˜“äºæ‰©å±•</strong>ï¼šæ–°å¢é…ç½®ç±»å‹åªéœ€æ·»åŠ å¯¹åº”æ¨¡å—</li>
                                    <li>ğŸ¨ <strong>ç»Ÿä¸€æ ·å¼</strong>ï¼šæ ·å¼æ¨¡å—åŒ–ï¼Œä¿æŒè§†è§‰ä¸€è‡´æ€§</li>
                                </ul>
                                <p>è¯·ä»å·¦ä¾§èœå•é€‰æ‹©è¦ç¼–è¾‘çš„é…ç½®ç±»å‹å¼€å§‹ã€‚</p>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦åŠŸèƒ½è„šæœ¬ -->
    <script>
        let currentConfigType = null;
        let currentConfigData = null;
        let userCredentials = null;

        // ç­‰å¾…æ¨¡å—åŠ è½½å®Œæˆ
        document.addEventListener('adminModulesLoaded', function() {
            console.log('ğŸ¯ ç®¡ç†é¢æ¿æ¨¡å—åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨');
            initializeEventListeners();
        });

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initializeEventListeners() {
            // é…ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.config-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const configType = this.dataset.config;
                    loadConfigType(configType);
                });
            });

            // è¡¨å•æäº¤äº‹ä»¶
            document.getElementById('config-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveConfig();
            });
        }

        // è®¤è¯å‡½æ•°
        async function authenticate() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                showMessage('auth-messages', 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error');
                return;
            }

            showMessage('auth-messages', 'æ­£åœ¨éªŒè¯...', 'info');

            try {
                // ç­‰å¾…æ¨¡å—åŠ è½½å®Œæˆ
                if (!window.enhancedAdminConfig) {
                    showMessage('auth-messages', 'é…ç½®ç®¡ç†æ¨¡å—æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...', 'info');
                    // ç­‰å¾…æ¨¡å—åŠ è½½
                    await new Promise(resolve => {
                        const checkInterval = setInterval(() => {
                            if (window.enhancedAdminConfig) {
                                clearInterval(checkInterval);
                                resolve();
                            }
                        }, 100);
                        // 10ç§’è¶…æ—¶
                        setTimeout(() => {
                            clearInterval(checkInterval);
                            resolve();
                        }, 10000);
                    });
                }

                if (!window.enhancedAdminConfig) {
                    throw new Error('é…ç½®ç®¡ç†æ¨¡å—åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }

                // æ£€æŸ¥APIçŠ¶æ€å¹¶æä¾›è¯¦ç»†ä¿¡æ¯
                if (window.enhancedAdminConfig.checkApiStatus) {
                    const apiStatus = await window.enhancedAdminConfig.checkApiStatus();
                    if (!apiStatus) {
                        showMessage('auth-messages', 'âš ï¸ APIæœåŠ¡ä¸å¯ç”¨ï¼Œæ­£åœ¨å°è¯•éªŒè¯...', 'warning');
                    }
                }

                const isValid = await window.enhancedAdminConfig.validateCredentials(username, password);
                if (isValid) {
                    userCredentials = `Basic ${btoa(`${username}:${password}`)}`;
                    document.getElementById('current-user').textContent = username;
                    showLoginSuccess();
                } else {
                    showMessage('auth-messages', 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œè¯·æ£€æŸ¥åé‡è¯•', 'error');
                }
            } catch (error) {
                console.error('ç™»å½•éªŒè¯å¤±è´¥:', error);
                
                // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œè§£å†³æ–¹æ¡ˆ
                let errorMessage = `ç™»å½•å¤±è´¥: ${error.message}`;
                
                if (error.message.includes('æœåŠ¡å™¨è¿æ¥å¤±è´¥')) {
                    errorMessage += '\n\nğŸ’¡ å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ:';
                    errorMessage += '\n1. æ£€æŸ¥EdgeOne Functionsæ˜¯å¦æ­£ç¡®éƒ¨ç½²';
                    errorMessage += '\n2. ç¡®è®¤APIç«¯ç‚¹é…ç½®æ­£ç¡®';
                    errorMessage += '\n3. å°è¯•ä½¿ç”¨è¯Šæ–­å·¥å…·æ’æŸ¥é—®é¢˜';
                    errorMessage += '\n\nğŸ”§ å»ºè®®è®¿é—®: admin/diagnostic.html';
                }
                
                showMessage('auth-messages', errorMessage, 'error');
            }
        }

        // æ˜¾ç¤ºç™»å½•æˆåŠŸ
        function showLoginSuccess() {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('main-workspace').style.display = 'block';
            document.getElementById('logout-btn').style.display = 'inline-block';
            updateConnectionStatus('å·²è¿æ¥', 'success');
        }

        // åˆ‡æ¢å¯†ç æ˜¾ç¤º/éšè—
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('password-toggle-icon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleIcon.className = 'fas fa-eye';
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            userCredentials = null;
            currentConfigType = null;
            currentConfigData = null;
            
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('main-workspace').style.display = 'none';
            document.getElementById('logout-btn').style.display = 'none';
            document.getElementById('current-user').textContent = 'æœªç™»å½•';
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('form-container').innerHTML = '<div class="welcome-message"><h4>å·²é€€å‡ºç™»å½•</h4><p>è¯·é‡æ–°ç™»å½•ä»¥ç»§ç»­ä½¿ç”¨ã€‚</p></div>';
            
            updateConnectionStatus('æœªè¿æ¥', 'error');
        }

        // åŠ è½½é…ç½®ç±»å‹
        async function loadConfigType(configType) {
            if (!userCredentials) {
                showMessage('editor-messages', 'è¯·å…ˆç™»å½•', 'error');
                return;
            }

            currentConfigType = configType;
            updateConfigTitle(configType);
            showMessage('editor-messages', 'æ­£åœ¨åŠ è½½é…ç½®...', 'info');

            try {
                if (!window.enhancedAdminConfig) {
                    throw new Error('é…ç½®ç®¡ç†æ¨¡å—æœªåŠ è½½');
                }
                
                const config = await window.enhancedAdminConfig.getConfig(configType);
                currentConfigData = config;
                
                // ç”Ÿæˆè¡¨å•
                if (window.configFormEditor) {
                    const formHtml = window.configFormEditor.generateForm(configType, config);
                    document.getElementById('form-container').innerHTML = formHtml;
                    
                    // å¯ç”¨ä¿å­˜å’Œé‡è½½æŒ‰é’®
                    document.getElementById('save-btn').disabled = false;
                    document.getElementById('reload-btn').disabled = false;
                    
                    showMessage('editor-messages', 'é…ç½®åŠ è½½æˆåŠŸ', 'success');
                } else {
                    throw new Error('è¡¨å•ç¼–è¾‘å™¨æœªåˆå§‹åŒ–');
                }
            } catch (error) {
                console.error('é…ç½®åŠ è½½å¤±è´¥:', error);
                showMessage('editor-messages', `é…ç½®åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ä¿å­˜é…ç½®
        async function saveConfig() {
            if (!currentConfigType || !userCredentials) {
                showMessage('editor-messages', 'æ²¡æœ‰å¯ä¿å­˜çš„é…ç½®', 'error');
                return;
            }

            if (!window.enhancedAdminConfig) {
                showMessage('editor-messages', 'é…ç½®ç®¡ç†æ¨¡å—æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
                return;
            }

            showMessage('editor-messages', 'æ­£åœ¨ä¿å­˜é…ç½®...', 'info');

            try {
                const formData = new FormData(document.getElementById('config-form'));
                const config = window.configFormEditor.formDataToConfig(formData);
                
                await window.enhancedAdminConfig.saveConfig(currentConfigType, config, userCredentials);
                currentConfigData = config;
                
                showMessage('editor-messages', 'é…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('é…ç½®ä¿å­˜å¤±è´¥:', error);
                showMessage('editor-messages', `ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é‡æ–°åŠ è½½é…ç½®
        function reloadConfig() {
            if (currentConfigType) {
                loadConfigType(currentConfigType);
            }
        }

        // æ›´æ–°é…ç½®æ ‡é¢˜
        function updateConfigTitle(configType) {
            const titles = {
                'index': 'é¦–é¡µé…ç½®',
                'products': 'äº§å“é…ç½®',
                'services': 'æœåŠ¡é…ç½®',
                'partners': 'åˆä½œä¼™ä¼´é…ç½®',
                'about': 'å…³äºæˆ‘ä»¬é…ç½®',
                'contact': 'è”ç³»æˆ‘ä»¬é…ç½®',
                'footer': 'é¡µè„šé…ç½®'
            };
            
            const title = titles[configType] || configType;
            document.getElementById('current-config-title').innerHTML = 
                `<i class="fas fa-edit"></i> ${title}`;
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(text, type) {
            const indicator = document.getElementById('connection-status');
            const iconClass = type === 'success' ? 'fa-circle text-success' : 
                            type === 'error' ? 'fa-circle text-danger' : 'fa-circle text-warning';
            
            indicator.innerHTML = `<i class="fas ${iconClass}"></i> ${text}`;
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            const alertClass = type === 'success' ? 'alert-success' : 
                             type === 'error' ? 'alert-danger' : 'alert-info';
            
            container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            
            // è‡ªåŠ¨æ¸…é™¤æˆåŠŸæ¶ˆæ¯
            if (type === 'success') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 3000);
            }
        }

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            updateConnectionStatus('æ­£åœ¨åˆå§‹åŒ–...', 'warning');
        });
    </script>
</body>
</html>