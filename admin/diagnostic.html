<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†é¢æ¿è¯Šæ–­å·¥å…·</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-unknown { background: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-stethoscope"></i> ç®¡ç†é¢æ¿è¯Šæ–­å·¥å…·</h1>
        
        <div class="test-section">
            <h3>ğŸ” ç³»ç»Ÿç¯å¢ƒæ£€æµ‹</h3>
            <p>æ£€æµ‹å½“å‰è¿è¡Œç¯å¢ƒå’ŒåŸºç¡€è®¾ç½®</p>
            <button class="btn" onclick="checkEnvironment()">
                <i class="fas fa-play"></i> æ£€æµ‹ç¯å¢ƒ
            </button>
            <div id="env-result"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸŒ APIè¿æ¥æµ‹è¯•</h3>
            <p>æµ‹è¯•EdgeOne Functions APIæ˜¯å¦æ­£å¸¸å·¥ä½œ</p>
            <button class="btn" onclick="testApiConnection()">
                <i class="fas fa-wifi"></i> æµ‹è¯•APIè¿æ¥
            </button>
            <button class="btn btn-secondary" onclick="testSpecificEndpoint()">
                <i class="fas fa-cog"></i> æµ‹è¯•å…·ä½“ç«¯ç‚¹
            </button>
            <div id="api-result"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ”‘ èº«ä»½éªŒè¯æµ‹è¯•</h3>
            <p>æµ‹è¯•ç”¨æˆ·åå¯†ç éªŒè¯åŠŸèƒ½</p>
            <div style="margin-bottom: 15px;">
                <input type="text" id="test-username" placeholder="æµ‹è¯•ç”¨æˆ·å" style="padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="password" id="test-password" placeholder="æµ‹è¯•å¯†ç " style="padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <button class="btn" onclick="testAuthentication()">
                    <i class="fas fa-key"></i> æµ‹è¯•éªŒè¯
                </button>
            </div>
            <div id="auth-result"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“ é…ç½®æ–‡ä»¶æµ‹è¯•</h3>
            <p>æµ‹è¯•é…ç½®æ–‡ä»¶çš„è¯»å–å’Œå†™å…¥åŠŸèƒ½</p>
            <button class="btn" onclick="testConfigFiles()">
                <i class="fas fa-file"></i> æµ‹è¯•é…ç½®æ–‡ä»¶
            </button>
            <button class="btn btn-secondary" onclick="testKVStorage()">
                <i class="fas fa-database"></i> æµ‹è¯•KVå­˜å‚¨
            </button>
            <div id="config-result"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ”§ ä¿®å¤å»ºè®®</h3>
            <p>æ ¹æ®æ£€æµ‹ç»“æœæä¾›ä¿®å¤å»ºè®®</p>
            <button class="btn btn-secondary" onclick="generateFixSuggestions()">
                <i class="fas fa-wrench"></i> ç”Ÿæˆä¿®å¤å»ºè®®
            </button>
            <div id="fix-result"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ”— å¿«é€Ÿè·³è½¬</h3>
            <button class="btn btn-secondary" onclick="window.open('admin-modular.html', '_blank')">æ‰“å¼€æ¨¡å—åŒ–ç®¡ç†ä¸­å¿ƒ</button>
            <button class="btn btn-secondary" onclick="window.open('../admin_manager.html', '_blank')">æ‰“å¼€åŸç‰ˆç®¡ç†ä¸­å¿ƒ</button>
            <button class="btn btn-secondary" onclick="window.open('../api-test.html', '_blank')">æ‰“å¼€APIæµ‹è¯•å·¥å…·</button>
        </div>
    </div>

    <script>
        let testResults = {};

        function showResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        async function checkEnvironment() {
            showResult('env-result', 'æ­£åœ¨æ£€æµ‹ç¯å¢ƒ...', 'info');
            
            const results = [];
            
            // æ£€æŸ¥å½“å‰URL
            results.push(`å½“å‰URL: ${window.location.href}`);
            
            // æ£€æŸ¥ç”¨æˆ·ä»£ç†
            results.push(`æµè§ˆå™¨: ${navigator.userAgent}`);
            
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                results.push('âœ… æœ¬åœ°å­˜å‚¨: å¯ç”¨');
            } catch (e) {
                results.push('âŒ æœ¬åœ°å­˜å‚¨: ä¸å¯ç”¨');
            }
            
            // æ£€æŸ¥æ–‡ä»¶åè®®
            if (window.location.protocol === 'file:') {
                results.push('âš ï¸ åè®®: file:// (å¯èƒ½å¯¼è‡´CORSé—®é¢˜)');
            } else {
                results.push(`âœ… åè®®: ${window.location.protocol}`);
            }
            
            // æ£€æŸ¥CSSæ–‡ä»¶
            const cssFiles = ['styles/core.css', 'styles/forms.css', 'styles/collapsible.css'];
            for (const cssFile of cssFiles) {
                try {
                    const response = await fetch(cssFile, { method: 'HEAD' });
                    if (response.ok) {
                        results.push(`âœ… CSSæ–‡ä»¶: ${cssFile}`);
                    } else {
                        results.push(`âŒ CSSæ–‡ä»¶: ${cssFile} (${response.status})`);
                    }
                } catch (e) {
                    results.push(`âŒ CSSæ–‡ä»¶: ${cssFile} (${e.message})`);
                }
            }
            
            testResults.environment = results;
            showResult('env-result', results.join('\n'), 'info');
        }

        async function testApiConnection() {
            showResult('api-result', 'æ­£åœ¨æµ‹è¯•APIè¿æ¥...', 'info');
            
            const results = [];
            const baseUrl = window.location.origin;
            
            // æµ‹è¯•åŸºç¡€APIç«¯ç‚¹
            const endpoints = [
                '/api/test',
                '/api/configs',
                '/api/config/index'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const url = baseUrl + endpoint;
                    results.push(`æµ‹è¯•: ${url}`);
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const text = await response.text();
                    
                    if (text.trim().startsWith('<')) {
                        results.push(`âŒ ${endpoint}: è¿”å›HTMLé¡µé¢ (Functionsæœªéƒ¨ç½²æˆ–è·¯ç”±é”™è¯¯)`);
                    } else {
                        try {
                            const json = JSON.parse(text);
                            results.push(`âœ… ${endpoint}: JSONå“åº” (${response.status})`);
                            results.push(`   å“åº”: ${JSON.stringify(json, null, 2).substring(0, 200)}...`);
                        } catch (e) {
                            results.push(`âš ï¸ ${endpoint}: éJSONå“åº” (${response.status})`);
                            results.push(`   å†…å®¹: ${text.substring(0, 200)}...`);
                        }
                    }
                } catch (error) {
                    results.push(`âŒ ${endpoint}: è¿æ¥å¤±è´¥ (${error.message})`);
                }
            }
            
            testResults.api = results;
            showResult('api-result', results.join('\n'), 'info');
        }

        async function testSpecificEndpoint() {
            const endpoint = prompt('è¯·è¾“å…¥è¦æµ‹è¯•çš„APIç«¯ç‚¹ (ä¾‹å¦‚: /api/test):');
            if (!endpoint) return;
            
            showResult('api-result', `æ­£åœ¨æµ‹è¯• ${endpoint}...`, 'info');
            
            try {
                const url = window.location.origin + endpoint;
                const response = await fetch(url);
                const text = await response.text();
                
                let result = `æµ‹è¯•ç«¯ç‚¹: ${endpoint}\n`;
                result += `çŠ¶æ€ç : ${response.status}\n`;
                result += `å“åº”å¤´: ${JSON.stringify(Object.fromEntries(response.headers), null, 2)}\n`;
                result += `å“åº”ä½“: ${text}`;
                
                const type = response.ok ? 'success' : 'error';
                showResult('api-result', result, type);
            } catch (error) {
                showResult('api-result', `æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testAuthentication() {
            const username = document.getElementById('test-username').value;
            const password = document.getElementById('test-password').value;
            
            if (!username || !password) {
                showResult('auth-result', 'è¯·è¾“å…¥æµ‹è¯•ç”¨æˆ·åå’Œå¯†ç ', 'warning');
                return;
            }
            
            showResult('auth-result', 'æ­£åœ¨æµ‹è¯•èº«ä»½éªŒè¯...', 'info');
            
            try {
                // åŠ è½½é…ç½®ç®¡ç†æ¨¡å—
                if (!window.FallbackConfigManager) {
                    await loadScript('../js/config-fallback.js');
                }
                
                const configManager = new window.FallbackConfigManager();
                const isValid = await configManager.validateCredentials(username, password);
                
                if (isValid) {
                    showResult('auth-result', 'âœ… èº«ä»½éªŒè¯æˆåŠŸï¼', 'success');
                } else {
                    showResult('auth-result', 'âŒ ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯', 'error');
                }
            } catch (error) {
                showResult('auth-result', `èº«ä»½éªŒè¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testConfigFiles() {
            showResult('config-result', 'æ­£åœ¨æµ‹è¯•é…ç½®æ–‡ä»¶...', 'info');
            
            const results = [];
            const configFiles = ['index', 'products', 'services', 'contact', 'footer', 'partners', 'about'];
            
            for (const configFile of configFiles) {
                try {
                    const response = await fetch(`../config/${configFile}.json`);
                    if (response.ok) {
                        const config = await response.json();
                        results.push(`âœ… ${configFile}.json: åŠ è½½æˆåŠŸ (${Object.keys(config).length} ä¸ªé…ç½®é¡¹)`);
                    } else {
                        results.push(`âŒ ${configFile}.json: åŠ è½½å¤±è´¥ (${response.status})`);
                    }
                } catch (error) {
                    results.push(`âŒ ${configFile}.json: ${error.message}`);
                }
            }
            
            testResults.configs = results;
            showResult('config-result', results.join('\n'), 'info');
        }

        async function testKVStorage() {
            showResult('config-result', 'æ­£åœ¨æµ‹è¯•KVå­˜å‚¨...', 'info');
            
            try {
                const response = await fetch('/api/configs');
                const text = await response.text();
                
                if (text.trim().startsWith('<')) {
                    showResult('config-result', 'âŒ KVå­˜å‚¨æµ‹è¯•å¤±è´¥: APIè¿”å›HTMLé¡µé¢\nè¿™é€šå¸¸è¡¨ç¤ºEdgeOne Functionsæ²¡æœ‰æ­£ç¡®éƒ¨ç½²', 'error');
                } else {
                    const result = JSON.parse(text);
                    showResult('config-result', `âœ… KVå­˜å‚¨è¿æ¥æ­£å¸¸\nå“åº”: ${JSON.stringify(result, null, 2)}`, 'success');
                }
            } catch (error) {
                showResult('config-result', `âŒ KVå­˜å‚¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function generateFixSuggestions() {
            const suggestions = [];
            
            // åŸºäºæµ‹è¯•ç»“æœç”Ÿæˆå»ºè®®
            if (testResults.api) {
                const hasApiErrors = testResults.api.some(result => result.includes('âŒ') || result.includes('è¿”å›HTMLé¡µé¢'));
                if (hasApiErrors) {
                    suggestions.push('ğŸ”§ EdgeOne Functionséƒ¨ç½²é—®é¢˜:');
                    suggestions.push('   1. æ£€æŸ¥EdgeOne Pagesæ§åˆ¶å°ä¸­Functionsæ˜¯å¦æ­£ç¡®éƒ¨ç½²');
                    suggestions.push('   2. ç¡®è®¤_routes.jsonæ–‡ä»¶é…ç½®æ­£ç¡®');
                    suggestions.push('   3. æ£€æŸ¥functions/api/ç›®å½•ä¸‹çš„æ–‡ä»¶æ˜¯å¦å®Œæ•´');
                    suggestions.push('   4. é‡æ–°éƒ¨ç½²Functionsä»£ç ');
                    suggestions.push('');
                }
            }
            
            if (testResults.environment) {
                const hasCssErrors = testResults.environment.some(result => result.includes('âŒ') && result.includes('CSS'));
                if (hasCssErrors) {
                    suggestions.push('ğŸ¨ CSSæ–‡ä»¶è·¯å¾„é—®é¢˜:');
                    suggestions.push('   1. ç¡®ä¿admin/styles/ç›®å½•ä¸‹çš„CSSæ–‡ä»¶å­˜åœ¨');
                    suggestions.push('   2. æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®');
                    suggestions.push('   3. å°è¯•åˆ·æ–°æµè§ˆå™¨ç¼“å­˜');
                    suggestions.push('');
                }
                
                const isFileProtocol = testResults.environment.some(result => result.includes('file://'));
                if (isFileProtocol) {
                    suggestions.push('âš ï¸ åè®®é—®é¢˜:');
                    suggestions.push('   1. å»ºè®®ä½¿ç”¨HTTPæœåŠ¡å™¨è¿è¡Œï¼Œè€Œä¸æ˜¯ç›´æ¥æ‰“å¼€HTMLæ–‡ä»¶');
                    suggestions.push('   2. å¯ä»¥ä½¿ç”¨VS Code Live Serveræˆ–å…¶ä»–æœ¬åœ°æœåŠ¡å™¨');
                    suggestions.push('   3. æˆ–è€…ç›´æ¥éƒ¨ç½²åˆ°EdgeOne Pages');
                    suggestions.push('');
                }
            }
            
            if (suggestions.length === 0) {
                suggestions.push('âœ… æœªå‘ç°æ˜æ˜¾é—®é¢˜ï¼Œç³»ç»Ÿçœ‹èµ·æ¥è¿è¡Œæ­£å¸¸');
                suggestions.push('');
                suggestions.push('å¦‚æœä»æœ‰é—®é¢˜ï¼Œè¯·å°è¯•:');
                suggestions.push('   1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜');
                suggestions.push('   2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯ä¿¡æ¯');
                suggestions.push('   3. ç¡®è®¤EdgeOne Pagesç¯å¢ƒå˜é‡é…ç½®');
            }
            
            showResult('fix-result', suggestions.join('\n'), 'warning');
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œç¯å¢ƒæ£€æµ‹
        window.addEventListener('load', () => {
            setTimeout(checkEnvironment, 500);
        });
    </script>
</body>
</html>