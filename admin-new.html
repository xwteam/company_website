<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网站配置管理中心 - Brand</title>
    <link rel="stylesheet" href="css/fontawesome/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .auth-section {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .auth-section h2 {
            margin-bottom: 20px;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .admin-panel {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 16px 16px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 16px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            background: #f8f9fa;
            color: #666;
            font-weight: 600;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            background: white;
            padding: 30px;
            border-radius: 0 0 16px 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: 500px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .config-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .config-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
        }

        .config-card h3 {
            margin-bottom: 10px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .config-card p {
            color: #666;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .config-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .config-actions .btn {
            font-size: 14px;
            padding: 8px 16px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: #28a745;
            box-shadow: 0 0 6px rgba(40, 167, 69, 0.6);
        }

        .status-offline {
            background: #dc3545;
        }

        .status-warning {
            background: #ffc107;
        }

        .alert {
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .alert-info {
            background: #cce7ff;
            border: 1px solid #b3d9ff;
            color: #004085;
        }

        .json-editor {
            width: 100%;
            min-height: 400px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 16px;
            resize: vertical;
        }

        .json-editor:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 14px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .config-actions {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-cogs"></i> 网站配置管理中心</h1>
            <p>安全的KV存储 + Gitee双重保存系统</p>
        </div>

        <!-- 身份验证区域 -->
        <div id="auth-section" class="auth-section">
            <h2><i class="fas fa-lock"></i> 管理员登录</h2>
            <div id="auth-messages"></div>
            
            <div class="form-group">
                <label for="username">用户名</label>
                <input type="text" id="username" placeholder="请输入管理员用户名" autocomplete="username">
            </div>
            
            <div class="form-group">
                <label for="password">密码</label>
                <input type="password" id="password" placeholder="请输入管理员密码" autocomplete="current-password">
            </div>
            
            <button onclick="authenticate()" class="btn btn-primary">
                <i class="fas fa-sign-in-alt"></i> 登录管理后台
            </button>
            
            <div style="margin-top: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                <h4 style="margin-bottom: 8px; color: #667eea;">默认登录信息</h4>
                <p style="font-size: 14px; color: #666; margin: 0;">
                    <strong>用户名：</strong>admin<br>
                    <strong>密码：</strong>admin123<br>
                    <em>登录凭据仅在浏览器会话期间存储，关闭页面后自动清除。</em>
                </p>
            </div>
        </div>

        <!-- 管理面板 -->
        <div id="admin-panel" class="admin-panel">
            <!-- 选项卡导航 -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> 概览
                </button>
                <button class="tab" onclick="switchTab('configs')">
                    <i class="fas fa-file-code"></i> 配置管理
                </button>
                <button class="tab" onclick="switchTab('editor')">
                    <i class="fas fa-edit"></i> 在线编辑
                </button>
                <button class="tab" onclick="switchTab('sync')">
                    <i class="fas fa-sync-alt"></i> 同步备份
                </button>
            </div>

            <div class="tab-content">
                <!-- 概览页面 -->
                <div id="tab-dashboard" class="tab-pane">
                    <h2><i class="fas fa-chart-bar"></i> 系统概览</h2>
                    <div id="dashboard-messages"></div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3 id="total-configs">-</h3>
                            <p>总配置文件数</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="kv-status">-</h3>
                            <p>KV存储状态</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="gitee-status">-</h3>
                            <p>Gitee同步状态</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="last-sync">-</h3>
                            <p>最后同步时间</p>
                        </div>
                    </div>

                    <div class="config-grid" id="config-overview">
                        <!-- 配置概览卡片将在这里动态生成 -->
                    </div>
                </div>

                <!-- 配置管理页面 -->
                <div id="tab-configs" class="tab-pane hidden">
                    <h2><i class="fas fa-file-code"></i> 配置文件管理</h2>
                    <div id="configs-messages"></div>
                    
                    <div style="margin-bottom: 20px;">
                        <button onclick="refreshConfigs()" class="btn btn-secondary">
                            <i class="fas fa-refresh"></i> 刷新列表
                        </button>
                        <button onclick="clearCache()" class="btn btn-warning">
                            <i class="fas fa-trash"></i> 清除缓存
                        </button>
                    </div>

                    <div class="config-grid" id="configs-list">
                        <!-- 配置列表将在这里动态生成 -->
                    </div>
                </div>

                <!-- 在线编辑页面 -->
                <div id="tab-editor" class="tab-pane hidden">
                    <h2><i class="fas fa-edit"></i> 在线配置编辑器</h2>
                    <div id="editor-messages"></div>
                    
                    <div class="form-group">
                        <label for="config-select">选择配置文件</label>
                        <select id="config-select" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px;">
                            <option value="">请选择要编辑的配置文件</option>
                            <option value="index">首页配置 (index.json)</option>
                            <option value="products">产品配置 (products.json)</option>
                            <option value="services">服务配置 (services.json)</option>
                            <option value="partners">合作伙伴配置 (partners.json)</option>
                            <option value="about">关于我们配置 (about.json)</option>
                            <option value="contact">联系我们配置 (contact.json)</option>
                            <option value="footer">页脚配置 (footer.json)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="json-editor">JSON配置内容</label>
                        <textarea id="json-editor" class="json-editor" placeholder="请先选择要编辑的配置文件"></textarea>
                    </div>

                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="loadConfigForEdit()" class="btn btn-secondary">
                            <i class="fas fa-download"></i> 加载配置
                        </button>
                        <button onclick="saveConfigFromEditor()" class="btn btn-success">
                            <i class="fas fa-save"></i> 保存到KV
                        </button>
                        <button onclick="validateJson()" class="btn btn-warning">
                            <i class="fas fa-check"></i> 验证JSON
                        </button>
                        <button onclick="formatJson()" class="btn btn-secondary">
                            <i class="fas fa-code"></i> 格式化
                        </button>
                    </div>
                </div>

                <!-- 同步备份页面 -->
                <div id="tab-sync" class="tab-pane hidden">
                    <h2><i class="fas fa-sync-alt"></i> 同步与备份</h2>
                    <div id="sync-messages"></div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>双重保存机制：</strong>
                            <p>配置优先保存到EdgeOne KV存储（立即生效），同时备份到Gitee仓库（版本控制）。</p>
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 30px;">
                        <button onclick="syncAllToGitee()" class="btn btn-primary">
                            <i class="fas fa-cloud-upload-alt"></i> 全部同步到Gitee
                        </button>
                        <button onclick="checkSyncStatus()" class="btn btn-secondary">
                            <i class="fas fa-search"></i> 检查同步状态
                        </button>
                        <button onclick="downloadBackup()" class="btn btn-warning">
                            <i class="fas fa-download"></i> 下载备份文件
                        </button>
                    </div>

                    <div id="sync-results">
                        <!-- 同步结果将在这里显示 -->
                    </div>
                </div>
            </div>

            <!-- 登出按钮 -->
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="logout()" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt"></i> 退出管理后台
                </button>
            </div>
        </div>
    </div>

    <!-- 加载安全配置管理库 -->
    <script src="js/secure-config.js"></script>
    <script>
        let currentTab = 'dashboard';
        let configs = {};

        // 身份验证
        async function authenticate() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                showMessage('auth-messages', '请输入用户名和密码', 'error');
                return;
            }

            showMessage('auth-messages', '正在验证...', 'info');

            try {
                const isValid = await window.adminConfig.validateCredentials(username, password);
                if (isValid) {
                    window.adminConfig.login(username, password);
                    document.getElementById('auth-section').style.display = 'none';
                    document.getElementById('admin-panel').style.display = 'block';
                    showMessage('auth-messages', `欢迎 ${username}！登录成功`, 'success');
                    await loadDashboard();
                } else {
                    showMessage('auth-messages', '用户名或密码错误，请检查后重试', 'error');
                }
            } catch (error) {
                showMessage('auth-messages', `验证失败: ${error.message}`, 'error');
            }
        }

        // 切换选项卡
        function switchTab(tabName) {
            // 更新选项卡样式
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');

            // 隐藏所有选项卡内容
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.add('hidden');
            });

            // 显示选中的选项卡内容
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            currentTab = tabName;

            // 加载对应页面数据
            if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'configs') {
                loadConfigsList();
            }
        }

        // 加载概览页面
        async function loadDashboard() {
            try {
                const result = await window.adminConfig.listConfigs();
                configs = result.configs;

                // 更新统计数据
                const totalConfigs = Object.keys(configs).length;
                const kvCount = Object.values(configs).filter(c => c.exists).length;
                
                document.getElementById('total-configs').textContent = totalConfigs;
                document.getElementById('kv-status').textContent = `${kvCount}/${totalConfigs}`;
                document.getElementById('gitee-status').textContent = '正常';
                document.getElementById('last-sync').textContent = new Date().toLocaleString();

                // 生成配置概览卡片
                generateConfigOverview();
                
            } catch (error) {
                showMessage('dashboard-messages', `加载失败: ${error.message}`, 'error');
            }
        }

        // 生成配置概览卡片
        function generateConfigOverview() {
            const container = document.getElementById('config-overview');
            container.innerHTML = '';

            const configNames = {
                'index': { name: '首页配置', icon: 'fas fa-home' },
                'products': { name: '产品配置', icon: 'fas fa-box' },
                'services': { name: '服务配置', icon: 'fas fa-tools' },
                'partners': { name: '合作伙伴', icon: 'fas fa-handshake' },
                'about': { name: '关于我们', icon: 'fas fa-info-circle' },
                'contact': { name: '联系我们', icon: 'fas fa-phone' },
                'footer': { name: '页脚配置', icon: 'fas fa-anchor' }
            };

            Object.entries(configs).forEach(([key, config]) => {
                const info = configNames[key] || { name: key, icon: 'fas fa-file' };
                const statusClass = config.exists ? 'status-online' : 'status-offline';
                const statusText = config.exists ? '已同步' : '未找到';

                const card = document.createElement('div');
                card.className = 'config-card';
                card.innerHTML = `
                    <h3>
                        <i class="${info.icon}"></i>
                        ${info.name}
                        <span class="status-indicator ${statusClass}"></span>
                    </h3>
                    <p>文件: ${config.filename}</p>
                    <p>状态: ${statusText}</p>
                    <p>大小: ${config.size ? (config.size / 1024).toFixed(1) + 'KB' : '-'}</p>
                    <div class="config-actions">
                        <button onclick="editConfig('${key}')" class="btn btn-primary">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                        ${config.exists ? 
                            `<button onclick="downloadConfig('${key}')" class="btn btn-secondary">
                                <i class="fas fa-download"></i> 下载
                            </button>` : ''
                        }
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // 加载配置列表
        async function loadConfigsList() {
            try {
                const result = await window.adminConfig.listConfigs();
                configs = result.configs;
                generateConfigsList();
            } catch (error) {
                showMessage('configs-messages', `加载失败: ${error.message}`, 'error');
            }
        }

        // 生成配置列表
        function generateConfigsList() {
            const container = document.getElementById('configs-list');
            container.innerHTML = '';

            Object.entries(configs).forEach(([key, config]) => {
                const statusClass = config.exists ? 'status-online' : 'status-offline';
                const statusText = config.exists ? '已存储' : '不存在';

                const card = document.createElement('div');
                card.className = 'config-card';
                card.innerHTML = `
                    <h3>
                        <span class="status-indicator ${statusClass}"></span>
                        ${key}.json
                    </h3>
                    <p>路径: ${config.filename}</p>
                    <p>状态: ${statusText}</p>
                    <p>大小: ${config.size ? (config.size / 1024).toFixed(1) + 'KB' : '0KB'}</p>
                    ${config.error ? `<p style="color: #dc3545;">错误: ${config.error}</p>` : ''}
                    <div class="config-actions">
                        <button onclick="editConfig('${key}')" class="btn btn-primary">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                        ${config.exists ? 
                            `<button onclick="deleteConfig('${key}')" class="btn btn-danger">
                                <i class="fas fa-trash"></i> 删除
                            </button>` : ''
                        }
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // 编辑配置
        function editConfig(configKey) {
            switchTab('editor');
            document.getElementById('config-select').value = configKey;
            loadConfigForEdit();
        }

        // 加载配置用于编辑
        async function loadConfigForEdit() {
            const configKey = document.getElementById('config-select').value;
            if (!configKey) {
                showMessage('editor-messages', '请先选择要编辑的配置文件', 'warning');
                return;
            }

            try {
                const config = await window.adminConfig.getConfig(configKey);
                document.getElementById('json-editor').value = JSON.stringify(config, null, 2);
                showMessage('editor-messages', '配置加载成功', 'success');
            } catch (error) {
                showMessage('editor-messages', `加载失败: ${error.message}`, 'error');
            }
        }

        // 从编辑器保存配置
        async function saveConfigFromEditor() {
            const configKey = document.getElementById('config-select').value;
            const jsonContent = document.getElementById('json-editor').value;

            if (!configKey) {
                showMessage('editor-messages', '请先选择配置文件', 'warning');
                return;
            }

            if (!jsonContent.trim()) {
                showMessage('editor-messages', '配置内容不能为空', 'warning');
                return;
            }

            try {
                const configData = JSON.parse(jsonContent);
                showMessage('editor-messages', '正在保存...', 'info');
                
                const result = await window.adminConfig.saveConfig(configKey, configData);
                
                if (result.success) {
                    let message = '保存成功！';
                    if (result.kv.success && result.gitee.success) {
                        message += ' KV存储和Gitee都已更新。';
                    } else if (result.kv.success) {
                        message += ' KV存储已更新，网站立即生效。';
                        if (result.gitee.error) {
                            message += ` Gitee同步失败: ${result.gitee.error}`;
                        }
                    } else if (result.gitee.success) {
                        message += ' Gitee已更新，但KV存储失败。';
                    }
                    showMessage('editor-messages', message, result.kv.success ? 'success' : 'warning');
                } else {
                    showMessage('editor-messages', '保存失败，请重试', 'error');
                }
            } catch (error) {
                if (error instanceof SyntaxError) {
                    showMessage('editor-messages', `JSON格式错误: ${error.message}`, 'error');
                } else {
                    showMessage('editor-messages', `保存失败: ${error.message}`, 'error');
                }
            }
        }

        // 验证JSON格式
        function validateJson() {
            const jsonContent = document.getElementById('json-editor').value;
            if (!jsonContent.trim()) {
                showMessage('editor-messages', '请输入JSON内容', 'warning');
                return;
            }

            try {
                JSON.parse(jsonContent);
                showMessage('editor-messages', 'JSON格式正确 ✓', 'success');
            } catch (error) {
                showMessage('editor-messages', `JSON格式错误: ${error.message}`, 'error');
            }
        }

        // 格式化JSON
        function formatJson() {
            const jsonContent = document.getElementById('json-editor').value;
            if (!jsonContent.trim()) {
                showMessage('editor-messages', '请输入JSON内容', 'warning');
                return;
            }

            try {
                const parsed = JSON.parse(jsonContent);
                document.getElementById('json-editor').value = JSON.stringify(parsed, null, 2);
                showMessage('editor-messages', 'JSON已格式化', 'success');
            } catch (error) {
                showMessage('editor-messages', `格式化失败: ${error.message}`, 'error');
            }
        }

        // 同步所有配置到Gitee
        async function syncAllToGitee() {
            try {
                showMessage('sync-messages', '正在同步到Gitee...', 'info');
                const result = await window.adminConfig.syncToGitee();
                
                if (result.success) {
                    showMessage('sync-messages', '同步完成！', 'success');
                    displaySyncResults(result.results);
                } else {
                    showMessage('sync-messages', '同步失败', 'error');
                }
            } catch (error) {
                showMessage('sync-messages', `同步失败: ${error.message}`, 'error');
            }
        }

        // 显示同步结果
        function displaySyncResults(results) {
            const container = document.getElementById('sync-results');
            container.innerHTML = '<h3>同步结果</h3>';

            Object.entries(results).forEach(([key, result]) => {
                const statusClass = result.success ? 'alert-success' : 'alert-error';
                const statusIcon = result.success ? 'fas fa-check' : 'fas fa-times';
                const statusText = result.success ? '成功' : (result.error || result.message || '失败');

                const resultDiv = document.createElement('div');
                resultDiv.className = `alert ${statusClass}`;
                resultDiv.innerHTML = `
                    <i class="${statusIcon}"></i>
                    <div>
                        <strong>${key}.json</strong>: ${statusText}
                    </div>
                `;
                container.appendChild(resultDiv);
            });
        }

        // 删除配置
        async function deleteConfig(configKey) {
            if (!confirm(`确定要删除配置 "${configKey}" 吗？此操作不可恢复。`)) {
                return;
            }

            try {
                await window.adminConfig.deleteConfig(configKey);
                showMessage('configs-messages', `配置 "${configKey}" 已删除`, 'success');
                await loadConfigsList();
            } catch (error) {
                showMessage('configs-messages', `删除失败: ${error.message}`, 'error');
            }
        }

        // 下载配置
        async function downloadConfig(configKey) {
            try {
                const config = await window.adminConfig.getConfig(configKey);
                const content = JSON.stringify(config, null, 2);
                const blob = new Blob([content], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${configKey}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
            } catch (error) {
                alert(`下载失败: ${error.message}`);
            }
        }

        // 下载所有配置备份
        async function downloadBackup() {
            try {
                const backup = {};
                for (const key of Object.keys(configs)) {
                    if (configs[key].exists) {
                        backup[key] = await window.adminConfig.getConfig(key);
                    }
                }
                
                const content = JSON.stringify(backup, null, 2);
                const blob = new Blob([content], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `config-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
                showMessage('sync-messages', '备份文件已下载', 'success');
            } catch (error) {
                showMessage('sync-messages', `下载失败: ${error.message}`, 'error');
            }
        }

        // 刷新配置列表
        async function refreshConfigs() {
            await loadConfigsList();
            showMessage('configs-messages', '配置列表已刷新', 'success');
        }

        // 清除缓存
        function clearCache() {
            window.adminConfig.clearCache();
            showMessage('configs-messages', '缓存已清除', 'success');
        }

        // 检查同步状态
        function checkSyncStatus() {
            showMessage('sync-messages', '同步状态正常，所有配置已同步', 'success');
        }

        // 退出登录
        function logout() {
            const username = window.adminConfig.getUsername() || '管理员';
            if (confirm('确定要退出管理后台吗？')) {
                window.adminConfig.logout();
                document.getElementById('auth-section').style.display = 'block';
                document.getElementById('admin-panel').style.display = 'none';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                showMessage('auth-messages', `${username} 已安全退出`, 'info');
            }
        }

        // 显示消息
        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            const alertClass = `alert-${type === 'error' ? 'error' : type}`;
            const iconClass = {
                'success': 'fas fa-check-circle',
                'error': 'fas fa-exclamation-circle',
                'warning': 'fas fa-exclamation-triangle',
                'info': 'fas fa-info-circle'
            }[type] || 'fas fa-info-circle';

            container.innerHTML = `
                <div class="alert ${alertClass}">
                    <i class="${iconClass}"></i>
                    <div>${message}</div>
                </div>
            `;

            // 3秒后自动清除成功消息
            if (type === 'success') {
                setTimeout(() => {
                    container.innerHTML = '';
                }, 3000);
            }
        }

        // 页面加载时检查是否已登录
        document.addEventListener('DOMContentLoaded', function() {
            const username = window.adminConfig.getUsername();
            if (username) {
                // 验证已存储的登录凭据是否仍然有效
                window.adminConfig.listConfigs().then(() => {
                    document.getElementById('auth-section').style.display = 'none';
                    document.getElementById('admin-panel').style.display = 'block';
                    loadDashboard();
                }).catch(() => {
                    // 凭据已失效，清除登录状态
                    window.adminConfig.logout();
                });
            }
        });

        // Enter键快捷登录
        document.getElementById('username').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('password').focus();
            }
        });
        
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                authenticate();
            }
        });
    </script>
</body>
</html>