<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç«™é…ç½®ç®¡ç† - JSONç¼–è¾‘å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 15px 30px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
            margin-right: 8px;
        }

        .status-indicator.connected {
            background: #28a745;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .content {
            padding: 30px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .config-card {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .config-card:hover {
            border-color: #4facfe;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.15);
        }

        .config-card.active {
            border-color: #4facfe;
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.1) 0%, rgba(0, 242, 254, 0.1) 100%);
        }

        .config-card h3 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1.2em;
        }

        .config-card p {
            color: #666;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .editor-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
            display: none;
        }

        .editor-section.active {
            display: block;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .editor-header h3 {
            color: #333;
            font-size: 1.3em;
        }

        .editor-actions {
            display: flex;
            gap: 10px;
        }

        #configEditor {
            width: 100%;
            height: 500px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            background: white;
            color: #333;
        }

        #configEditor:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
        }

        /* JSONå·¥å…·æŒ‰é’®æ ·å¼ */
        .json-tools {
            margin: 15px 0;
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e1e5e9;
        }

        .json-tools .btn {
            margin: 0 5px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .messages {
            margin-top: 20px;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b8daff;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ç™»å½•è¡¨å•æ ·å¼ */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .login-form {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            position: relative;
        }

        .login-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .form-group.checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group.checkbox input {
            width: auto;
        }

        .password-toggle {
            position: relative;
        }

        .password-toggle-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
        }

        .login-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4facfe;
        }

        .login-info h4 {
            color: #1976d2;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .login-info p {
            color: #555;
            font-size: 13px;
            margin: 0;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 12px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .content {
                padding: 20px;
            }

            .config-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .status-bar {
                padding: 10px 20px;
                flex-direction: column;
                gap: 10px;
            }

            #configEditor {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é®ç½©å±‚ -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-form">
            <h2>ç®¡ç†å‘˜ç™»å½•</h2>
            
            <div class="login-info">
                <h4>ğŸ” å®‰å…¨ç™»å½•</h4>
            </div>
            
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="username">ç”¨æˆ·å</label>
                    <input type="text" id="username" required>
                </div>
                
                <div class="form-group">
                    <label for="password">å¯†ç </label>
                    <div class="password-toggle">
                        <input type="password" id="password" required>
                        <button type="button" class="password-toggle-btn" onclick="togglePassword()">ğŸ‘ï¸</button>
                    </div>
                </div>
                
                <div class="form-group checkbox">
                    <input type="checkbox" id="rememberMe">
                    <label for="rememberMe">è®°ä½ç™»å½•çŠ¶æ€</label>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    ç™»å½•ç®¡ç†åå°
                </button>
            </form>
            
            <div id="loginMessage"></div>
        </div>
    </div>

    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸš€ ç½‘ç«™é…ç½®ç®¡ç†</h1>
            <p>JSONç¼–è¾‘å™¨ - ç›´æ¥ç¼–è¾‘é…ç½®æ–‡ä»¶å¹¶åŒæ­¥åˆ°Gitee</p>
        </div>

        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="display: flex; align-items: center;">
                    <div id="statusIndicator" class="status-indicator"></div>
                    <span id="statusText">åˆå§‹åŒ–ä¸­...</span>
                </div>
                
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label for="storageType" style="font-size: 14px; color: #555;">å­˜å‚¨ç±»å‹:</label>
                    <select id="storageType" onchange="changeStorageType()" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                        <option value="gitee">Gitee ä»“åº“</option>
                        <option value="kv">EdgeOne KV</option>
                    </select>
                </div>
            </div>
            
            <div class="user-info">
                <span id="currentUser"></span>
                <button class="btn btn-secondary" onclick="showMigrationPanel()" style="padding: 6px 12px; font-size: 12px; margin-right: 8px;">
                    ğŸ”„ æ•°æ®è¿ç§»
                </button>
                <button class="btn btn-secondary" onclick="logout()" style="padding: 6px 12px; font-size: 12px;">
                    é€€å‡ºç™»å½•
                </button>
            </div>
        </div>

        <!-- ä¸»è¦å†…å®¹ -->
        <div class="content">
            <!-- é…ç½®é€‰æ‹©å™¨ -->
            <div id="configGrid" class="config-grid">
                <!-- é…ç½®å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <!-- ç¼–è¾‘å™¨åŒºåŸŸ -->
            <div id="editorSection" class="editor-section">
                <div class="editor-header">
                    <h3 id="currentConfigTitle">é…ç½®ç¼–è¾‘å™¨</h3>
                    <div class="editor-actions">
                        <button class="btn btn-secondary" onclick="reloadConfig()">
                            ğŸ”„ é‡æ–°åŠ è½½
                        </button>
                        <button class="btn btn-success" onclick="saveConfig()">
                            ğŸ’¾ ä¿å­˜åˆ°Gitee
                        </button>
                    </div>
                </div>
                
                <textarea id="configEditor" placeholder="é€‰æ‹©ä¸€ä¸ªé…ç½®æ–‡ä»¶å¼€å§‹ç¼–è¾‘..."></textarea>
                
                <!-- JSONå·¥å…·æŒ‰é’® -->
                <div class="json-tools">
                    <button type="button" class="btn btn-secondary" onclick="checkJsonFormat()">
                        ğŸ” æ£€æŸ¥JSONæ ¼å¼
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="formatJson()">
                        âœ¨ æ ¼å¼åŒ–JSON
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="testEncoding()">
                        ğŸ§ª æµ‹è¯•ä¸­æ–‡ç¼–ç 
                    </button>
                </div>
                
                <div id="messages" class="messages"></div>
            </div>

            <!-- äº§å“ç®¡ç†å™¨åŒºåŸŸ -->
            <div id="productManager" class="editor-section" style="display: none;">
                <div class="editor-header">
                    <h3>ğŸ“‹ äº§å“ç®¡ç†å™¨</h3>
                    <div class="editor-actions">
                        <button class="btn btn-secondary" onclick="getTimestamp()">
                            ğŸ• è·å–æ—¶é—´æˆ³
                        </button>
                        <button class="btn btn-secondary" onclick="listProducts()">
                            ğŸ“œ äº§å“åˆ—è¡¨
                        </button>
                    </div>
                </div>

                <div class="product-controls">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 20px;">
                        <label for="productItem" style="font-weight: 500;">äº§å“Item:</label>
                        <input type="text" id="productItem" placeholder="è¾“å…¥äº§å“itemï¼ˆå¦‚ï¼š1703876521000ï¼‰" 
                               style="flex: 1; padding: 8px 12px; border: 2px solid #e1e5e9; border-radius: 6px;">
                        <button class="btn btn-primary" onclick="loadProduct()">
                            ğŸ“¥ åŠ è½½äº§å“
                        </button>
                        <button class="btn btn-success" onclick="saveProduct()">
                            ğŸ’¾ ä¿å­˜äº§å“
                        </button>
                    </div>
                </div>

                <textarea id="productEditor" placeholder="è¾“å…¥äº§å“itemåç‚¹å‡»'åŠ è½½äº§å“'ï¼Œæˆ–ç›´æ¥è¾“å…¥æ–°äº§å“çš„JSONæ•°æ®..."
                         style="width: 100%; height: 400px; border: 2px solid #e1e5e9; border-radius: 8px; padding: 20px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 14px; line-height: 1.6; resize: vertical; background: white; color: #333;"></textarea>

                <div class="json-tools">
                    <button type="button" class="btn btn-secondary" onclick="checkProductJsonFormat()">
                        ğŸ” æ£€æŸ¥JSONæ ¼å¼
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="formatProductJson()">
                        âœ¨ æ ¼å¼åŒ–JSON
                    </button>
                </div>

                <div id="productMessages" class="messages"></div>
                <div id="productsList" style="margin-top: 20px;"></div>
            </div>

            <!-- æ•°æ®è¿ç§»é¢æ¿ -->
            <div id="migrationPanel" class="editor-section" style="display: none;">
                <div class="editor-header">
                    <h3>ğŸ”„ æ•°æ®è¿ç§»ç®¡ç†</h3>
                    <div class="editor-actions">
                        <button class="btn btn-secondary" onclick="getStorageInfo()">
                            ğŸ“Š å­˜å‚¨ä¿¡æ¯
                        </button>
                        <button class="btn btn-secondary" onclick="hideMigrationPanel()">
                            âœ–ï¸ å…³é—­
                        </button>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div style="border: 2px solid #e1e5e9; border-radius: 8px; padding: 15px;">
                        <h4>ğŸ“ Gitee â†’ EdgeOne KV</h4>
                        <p style="color: #666; font-size: 14px; margin: 10px 0;">å°†æ•°æ®ä»Giteeä»“åº“è¿ç§»åˆ°EdgeOne KVå­˜å‚¨</p>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="migrateData('migrateGiteeToKV', 'all')">
                                å…¨éƒ¨è¿ç§»
                            </button>
                            <button class="btn btn-secondary" onclick="migrateData('migrateGiteeToKV', 'configs')">
                                é…ç½®æ–‡ä»¶
                            </button>
                            <button class="btn btn-secondary" onclick="migrateData('migrateGiteeToKV', 'products')">
                                äº§å“æ–‡ä»¶
                            </button>
                        </div>
                    </div>

                    <div style="border: 2px solid #e1e5e9; border-radius: 8px; padding: 15px;">
                        <h4>â˜ï¸ EdgeOne KV â†’ Gitee</h4>
                        <p style="color: #666; font-size: 14px; margin: 10px 0;">å°†æ•°æ®ä»EdgeOne KVå­˜å‚¨è¿ç§»åˆ°Giteeä»“åº“</p>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="migrateData('migrateKVToGitee', 'all')">
                                å…¨éƒ¨è¿ç§»
                            </button>
                            <button class="btn btn-secondary" onclick="migrateData('migrateKVToGitee', 'configs')">
                                é…ç½®æ–‡ä»¶
                            </button>
                            <button class="btn btn-secondary" onclick="migrateData('migrateKVToGitee', 'products')">
                                äº§å“æ–‡ä»¶
                            </button>
                        </div>
                    </div>
                </div>

                <div id="storageInfo" style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px; display: none;">
                    <!-- å­˜å‚¨ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>

                <div id="migrationMessages" class="messages"></div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="loadingIndicator" class="loading">
        <div class="spinner"></div>
        <div style="text-align: center; color: #666;">
            æ­£åœ¨å¤„ç†ï¼Œè¯·ç¨å€™...
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let isLoggedIn = false;
        let currentUser = null;
        let currentConfigKey = null;
        let currentConfigData = null;
        let isModified = false;
        let currentStorageType = 'gitee'; // 'gitee' æˆ– 'kv'

        // ä¸­æ–‡å®‰å…¨çš„Base64ç¼–ç è§£ç å‡½æ•°
        function safeBase64Decode(str) {
            try {
                // æ–¹æ³•1ï¼šç›´æ¥è§£ç 
                return decodeURIComponent(escape(atob(str)));
            } catch (e) {
                try {
                    // æ–¹æ³•2ï¼šä½¿ç”¨TextDecoder
                    const bytes = new Uint8Array(atob(str).split('').map(c => c.charCodeAt(0)));
                    return new TextDecoder('utf-8').decode(bytes);
                } catch (e2) {
                    // æ–¹æ³•3ï¼šç®€å•è§£ç 
                    return atob(str);
                }
            }
        }

        function safeBase64Encode(str) {
            try {
                return btoa(unescape(encodeURIComponent(str)));
            } catch (e) {
                // å¤‡ç”¨æ–¹æ³•
                return btoa(str);
            }
        }

        // Giteeé…ç½®ï¼ˆå°†ä»æœåŠ¡å™¨è·å–ï¼‰
        let giteeConfig = {
            username: '',
            repo: '',
            token: ''
        };

        // é…ç½®æ–‡ä»¶æ˜ å°„
        const configFiles = {
            index: {
                name: 'é¦–é¡µé…ç½®',
                description: 'é¦–é¡µå†…å®¹ã€è‹±é›„åŒºåŸŸã€æœåŠ¡ä»‹ç»ç­‰é…ç½®',
                file: 'config/index.json',
                icon: 'ğŸ '
            },
            products: {
                name: 'äº§å“é…ç½®',
                description: 'äº§å“åˆ—è¡¨ã€åˆ†ç±»ã€ç‰¹è‰²äº§å“ç­‰é…ç½®',
                file: 'config/products.json',
                icon: 'ğŸ“¦'
            },
            services: {
                name: 'æœåŠ¡é…ç½®',
                description: 'æœåŠ¡ä»‹ç»ã€æœåŠ¡åˆ—è¡¨ç­‰é…ç½®',
                file: 'config/services.json',
                icon: 'ğŸ› ï¸'
            },
            partners: {
                name: 'åˆä½œä¼™ä¼´é…ç½®',
                description: 'åˆä½œä¼™ä¼´ä¿¡æ¯ã€Logoç­‰é…ç½®',
                file: 'config/partners.json',
                icon: 'ğŸ¤'
            },
            about: {
                name: 'å…³äºæˆ‘ä»¬é…ç½®',
                description: 'å…¬å¸ä»‹ç»ã€å›¢é˜Ÿä¿¡æ¯ç­‰é…ç½®',
                file: 'config/about.json',
                icon: 'ğŸ¢'
            },
            contact: {
                name: 'è”ç³»æˆ‘ä»¬é…ç½®',
                description: 'è”ç³»ä¿¡æ¯ã€åœ°å›¾é…ç½®ç­‰',
                file: 'config/contact.json',
                icon: 'ğŸ“'
            },
            footer: {
                name: 'é¡µè„šé…ç½®',
                description: 'é¡µè„šä¿¡æ¯ã€é“¾æ¥ã€ç‰ˆæƒç­‰é…ç½®',
                file: 'config/footer.json',
                icon: 'âš“'
            },
            products_manager: {
                name: 'äº§å“ç®¡ç†',
                description: 'ç®¡ç†å•ä¸ªäº§å“æ–‡ä»¶ï¼Œå¢åŠ ã€ä¿®æ”¹ã€åˆ é™¤äº§å“',
                file: '',
                icon: 'ğŸ“‹',
                type: 'products'
            }
        };

        // åˆå§‹åŒ–é¡µé¢
        async function init() {
            console.log('ğŸš€ åˆå§‹åŒ–ç®¡ç†åå°...');
            await checkLoginStatus();
            renderConfigCards();
            updateStatus('å°±ç»ª', false);
            console.log('âœ… ç®¡ç†åå°åˆå§‹åŒ–å®Œæˆ');
        }

        // è·å–Giteeé…ç½®
        async function loadGiteeConfig() {
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Basic ${btoa(`${currentUser}:${localStorage.getItem('adminCredentials') ? JSON.parse(localStorage.getItem('adminCredentials')).password : ''}`)}`
                    },
                    body: JSON.stringify({ action: 'getGiteeConfig' })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        giteeConfig = result.config;
                        console.log('âœ… Giteeé…ç½®åŠ è½½æˆåŠŸ');
                    }
                }
            } catch (error) {
                console.warn('âš ï¸ Giteeé…ç½®åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨ç©ºé…ç½®:', error);
            }
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            const savedCredentials = localStorage.getItem('adminCredentials');
            const savedUsername = localStorage.getItem('adminUsername');
            
            if (savedCredentials && savedUsername) {
                // éªŒè¯ä¿å­˜çš„å‡­æ®
                try {
                    const credentials = JSON.parse(savedCredentials);
                    const isValid = await validateCredentials(credentials.username, credentials.password);
                    
                    if (isValid) {
                        isLoggedIn = true;
                        currentUser = savedUsername;
                        document.getElementById('currentUser').textContent = `ğŸ‘¤ ${currentUser}`;
                        hideLoginForm();
                        return;
                    } else {
                        // æ¸…é™¤æ— æ•ˆçš„ä¿å­˜å‡­æ®
                        localStorage.removeItem('adminCredentials');
                        localStorage.removeItem('adminUsername');
                    }
                } catch (error) {
                    console.warn('ä¿å­˜çš„ç™»å½•ä¿¡æ¯éªŒè¯å¤±è´¥:', error);
                    // æ¸…é™¤æ— æ•ˆçš„ä¿å­˜å‡­æ®
                    localStorage.removeItem('adminCredentials');
                    localStorage.removeItem('adminUsername');
                }
            }
            
            // æ˜¾ç¤ºç™»å½•è¡¨å•
            showLoginForm();
        }

        // æ˜¾ç¤ºç™»å½•è¡¨å•
        function showLoginForm() {
            document.getElementById('loginOverlay').style.display = 'flex';
        }

        // éšè—ç™»å½•è¡¨å•
        function hideLoginForm() {
            document.getElementById('loginOverlay').style.display = 'none';
            // é‡æ–°æ¸²æŸ“é…ç½®å¡ç‰‡ä»¥æ˜¾ç¤ºå†…å®¹
            renderConfigCards();
        }

        // éªŒè¯ç”¨æˆ·å‡­æ®ï¼ˆé€šè¿‡EdgeOne Functions APIï¼‰
        async function validateCredentials(username, password) {
            try {
                const response = await fetch('/api/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    return result.success;
                } else {
                    console.error('è®¤è¯è¯·æ±‚å¤±è´¥:', response.status, response.statusText);
                    return false;
                }
            } catch (error) {
                console.error('è®¤è¯è¿‡ç¨‹ä¸­å‡ºé”™:', error);
                return false;
            }
        }

        // å¤„ç†ç™»å½•
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            
            // æ˜¾ç¤ºç™»å½•ä¸­çŠ¶æ€
            showLoginMessage('æ­£åœ¨éªŒè¯ç™»å½•ä¿¡æ¯...', 'info');
            
            try {
                const isValid = await validateCredentials(username, password);
                
                if (isValid) {
                    isLoggedIn = true;
                    currentUser = username;
                    
                    // ä¿å­˜ç™»å½•çŠ¶æ€
                    if (rememberMe) {
                        localStorage.setItem('adminUsername', username);
                        localStorage.setItem('adminCredentials', JSON.stringify({
                            username: username,
                            password: password
                        }));
                    }
                    
                    document.getElementById('currentUser').textContent = `ğŸ‘¤ ${username}`;
                    
                    // åŠ è½½Giteeé…ç½®
                    await loadGiteeConfig();
                    
                    hideLoginForm();
                    showLoginMessage('ç™»å½•æˆåŠŸï¼', 'success');
                    
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('loginForm').reset();
                    
                } else {
                    showLoginMessage('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
                }
            } catch (error) {
                console.error('ç™»å½•è¿‡ç¨‹ä¸­å‡ºé”™:', error);
                showLoginMessage('ç™»å½•éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (isModified && !confirm('å½“å‰æœ‰æœªä¿å­˜çš„ä¿®æ”¹ï¼Œç¡®å®šè¦é€€å‡ºå—ï¼Ÿ')) {
                return;
            }
            
            isLoggedIn = false;
            currentUser = null;
            
            // æ¸…é™¤ä¿å­˜çš„ç™»å½•çŠ¶æ€
            localStorage.removeItem('adminUsername');
            localStorage.removeItem('adminCredentials');
            
            // é‡ç½®ç•Œé¢
            document.getElementById('currentUser').textContent = '';
            document.getElementById('editorSection').classList.remove('active');
            document.querySelectorAll('.config-card').forEach(card => {
                card.classList.remove('active');
            });
            
            currentConfigKey = null;
            currentConfigData = null;
            isModified = false;
            
            // æ¸…ç©ºç¼–è¾‘å™¨å†…å®¹
            document.getElementById('configEditor').value = '';
            
            // é‡æ–°æ¸²æŸ“é…ç½®å¡ç‰‡ï¼ˆæ˜¾ç¤ºç™»å½•æç¤ºï¼‰
            renderConfigCards();
            
            showLoginForm();
        }

        // åˆ‡æ¢å¯†ç æ˜¾ç¤º/éšè—
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const button = document.querySelector('.password-toggle-btn');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                button.textContent = 'ğŸ™ˆ';
            } else {
                passwordInput.type = 'password';
                button.textContent = 'ğŸ‘ï¸';
            }
        }

        // æ˜¾ç¤ºç™»å½•æ¶ˆæ¯
        function showLoginMessage(message, type) {
            const messageDiv = document.getElementById('loginMessage');
            messageDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            // 3ç§’åæ¸…é™¤æ¶ˆæ¯
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 3000);
        }

        // æ¸²æŸ“é…ç½®å¡ç‰‡
        function renderConfigCards() {
            const grid = document.getElementById('configGrid');
            grid.innerHTML = '';

            // å¦‚æœæœªç™»å½•ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
            if (!isLoggedIn) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6c757d; grid-column: 1 / -1;">
                        <h3>ğŸ”’ è¯·å…ˆç™»å½•</h3>
                        <p>ç™»å½•åå³å¯ç®¡ç†ç½‘ç«™é…ç½®</p>
                    </div>
                `;
                return;
            }

            Object.keys(configFiles).forEach(key => {
                const config = configFiles[key];
                const card = document.createElement('div');
                card.className = 'config-card';
                card.onclick = () => selectConfig(key);
                
                card.innerHTML = `
                    <h3>${config.icon} ${config.name}</h3>
                    <p>${config.description}</p>
                `;
                
                grid.appendChild(card);
            });
        }

        // é€‰æ‹©é…ç½®
        async function selectConfig(configKey) {
            if (!isLoggedIn) {
                showMessage('è¯·å…ˆç™»å½•', 'error');
                return;
            }

            if (isModified && !confirm('å½“å‰æœ‰æœªä¿å­˜çš„ä¿®æ”¹ï¼Œç¡®å®šè¦åˆ‡æ¢é…ç½®å—ï¼Ÿ')) {
                return;
            }

            // æ›´æ–°ç•Œé¢çŠ¶æ€
            document.querySelectorAll('.config-card').forEach(card => {
                card.classList.remove('active');
            });
            event.target.closest('.config-card').classList.add('active');

            currentConfigKey = configKey;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯äº§å“ç®¡ç†
            if (configFiles[configKey].type === 'products') {
                showProductManager();
            } else {
                document.getElementById('editorSection').classList.add('active');
                document.getElementById('currentConfigTitle').textContent = `${configFiles[configKey].icon} ${configFiles[configKey].name}`;
                
                // åŠ è½½é…ç½®
                await loadConfigFromStorage(configKey);
            }
        }

        // åŠ è½½é…ç½®æ–‡ä»¶ (æ”¯æŒGiteeå’ŒKVå­˜å‚¨)
        async function loadConfigFromStorage(configKey) {
            showLoading(true);
            updateStatus('æ­£åœ¨åŠ è½½...', false);
            clearMessages();

            try {
                const config = configFiles[configKey];
                
                if (currentStorageType === 'kv') {
                    // ä»KVå­˜å‚¨åŠ è½½é…ç½®
                    const response = await fetch('/api/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': getAuthHeader()
                        },
                        body: JSON.stringify({ 
                            action: 'getConfig',
                            configType: configKey,
                            storageType: 'kv'
                        })
                    });

                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error(`é…ç½® ${configKey} åœ¨KVå­˜å‚¨ä¸­ä¸å­˜åœ¨`);
                        }
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.message || result.error);
                    }

                    currentConfigData = {
                        content: result.config,
                        source: 'kv'
                    };

                    // æ˜¾ç¤ºJSONå†…å®¹ä¾›ç¼–è¾‘
                    const jsonString = JSON.stringify(result.config, null, 2);
                    document.getElementById('configEditor').value = jsonString;
                    isModified = false;
                    
                    showMessage('é…ç½®ä»KVå­˜å‚¨åŠ è½½æˆåŠŸ', 'success');
                    updateStatus('KVå·²è¿æ¥', true);
                } else {
                    // ä»GiteeåŠ è½½é…ç½®
                    const url = `https://gitee.com/api/v5/repos/${giteeConfig.username}/${giteeConfig.repo}/contents/${config.file}?access_token=${giteeConfig.token}`;
                    
                    console.log('æ­£åœ¨è¯·æ±‚Gitee API:', url.replace(giteeConfig.token, '***TOKEN***'));
                    
                    const response = await fetch(url);
                    
                    console.log('Gitee APIå“åº”çŠ¶æ€:', response.status, response.statusText);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    // ä½¿ç”¨å®‰å…¨çš„ä¸­æ–‡è§£ç 
                    const decodedContent = safeBase64Decode(data.content);
                    const content = JSON.parse(decodedContent);
                    
                    currentConfigData = {
                        content: content,
                        sha: data.sha,
                        source: 'gitee'
                    };

                    // æ˜¾ç¤ºJSONå†…å®¹ä¾›ç¼–è¾‘
                    const jsonString = JSON.stringify(content, null, 2);
                    document.getElementById('configEditor').value = jsonString;
                    isModified = false;
                    
                    // è°ƒè¯•ï¼šæ£€æŸ¥ä¸­æ–‡å­—ç¬¦
                    console.log('åŠ è½½çš„JSONå†…å®¹é¢„è§ˆ:', jsonString.substring(0, 200));
                    console.log('åŒ…å«ä¸­æ–‡å­—ç¬¦:', /[\u4e00-\u9fa5]/.test(jsonString));
                    
                    showMessage('é…ç½®ä»GiteeåŠ è½½æˆåŠŸ', 'success');
                    updateStatus('Giteeå·²è¿æ¥', true);
                }

            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                showMessage(`åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                updateStatus('åŠ è½½å¤±è´¥', false);
            } finally {
                showLoading(false);
            }
        }

        // ä¿å­˜é…ç½® (æ”¯æŒGiteeå’ŒKVå­˜å‚¨)
        async function saveConfig() {
            if (!currentConfigKey || !currentConfigData) {
                showMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé…ç½®æ–‡ä»¶', 'info');
                return;
            }

            const editorContent = document.getElementById('configEditor').value;
            
            // éªŒè¯JSONæ ¼å¼
            let configData;
            try {
                configData = JSON.parse(editorContent);
            } catch (error) {
                showMessage(`JSONæ ¼å¼é”™è¯¯: ${error.message}`, 'error');
                return;
            }

            showLoading(true);
            updateStatus('æ­£åœ¨ä¿å­˜...', false);
            clearMessages();

            try {
                if (currentStorageType === 'kv') {
                    // ä¿å­˜åˆ°KVå­˜å‚¨
                    const response = await fetch('/api/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': getAuthHeader()
                        },
                        body: JSON.stringify({ 
                            action: 'saveConfig',
                            configType: currentConfigKey,
                            configData: configData,
                            storageType: 'kv'
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.message || result.error);
                    }

                    currentConfigData.content = configData;
                    currentConfigData.source = 'kv';
                    isModified = false;
                    
                    showMessage('âœ… é…ç½®ä¿å­˜æˆåŠŸï¼å·²åŒæ­¥åˆ°EdgeOne KVå­˜å‚¨', 'success');
                    updateStatus('KVå·²ä¿å­˜', true);
                } else {
                    // ä¿å­˜åˆ°Gitee
                    const config = configFiles[currentConfigKey];
                    const url = `https://gitee.com/api/v5/repos/${giteeConfig.username}/${giteeConfig.repo}/contents/${config.file}`;
                    
                    const requestBody = {
                        access_token: giteeConfig.token,
                        content: safeBase64Encode(editorContent),
                        message: `æ›´æ–° ${config.name} é…ç½®`,
                        sha: currentConfigData.sha
                    };
                    
                    console.log('æ­£åœ¨ä¿å­˜åˆ°Gitee...', {
                        url: url.replace(giteeConfig.token, '***TOKEN***'),
                        message: requestBody.message
                    });
                    
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorData = await response.text();
                        console.error('ä¿å­˜å¤±è´¥å“åº”:', errorData);
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    console.log('ä¿å­˜æˆåŠŸ:', result);
                    
                    // æ›´æ–°SHAå€¼
                    currentConfigData.sha = result.content.sha;
                    currentConfigData.content = configData;
                    currentConfigData.source = 'gitee';
                    isModified = false;
                    
                    showMessage('âœ… é…ç½®ä¿å­˜æˆåŠŸï¼å·²åŒæ­¥åˆ°Giteeä»“åº“', 'success');
                    updateStatus('Giteeå·²ä¿å­˜', true);
                }

            } catch (error) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                showMessage(`ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
                updateStatus('ä¿å­˜å¤±è´¥', false);
            } finally {
                showLoading(false);
            }
        }

        // é‡æ–°åŠ è½½é…ç½®
        async function reloadConfig() {
            if (!currentConfigKey) {
                showMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé…ç½®æ–‡ä»¶', 'info');
                return;
            }

            if (isModified) {
                if (!confirm('å½“å‰æœ‰æœªä¿å­˜çš„ä¿®æ”¹ï¼Œç¡®å®šè¦é‡æ–°åŠ è½½å—ï¼Ÿ')) {
                    return;
                }
            }

            await loadConfigFromStorage(currentConfigKey);
        }

        // JSONæ ¼å¼æ£€æŸ¥åŠŸèƒ½
        function checkJsonFormat() {
            const editor = document.getElementById('configEditor');
            const content = editor.value.trim();
            
            if (!content) {
                showMessage('ç¼–è¾‘å™¨ä¸ºç©ºï¼Œè¯·å…ˆåŠ è½½é…ç½®æ–‡ä»¶', 'info');
                return;
            }
            
            try {
                JSON.parse(content);
                showMessage('âœ… JSONæ ¼å¼æ­£ç¡®ï¼', 'success');
            } catch (error) {
                // å°è¯•æ‰¾åˆ°é”™è¯¯ä½ç½®
                const lines = content.split('\n');
                let errorLine = 1;
                let errorColumn = 1;
                
                // ä»é”™è¯¯ä¿¡æ¯ä¸­æå–ä½ç½®ä¿¡æ¯
                const positionMatch = error.message.match(/position (\d+)/);
                if (positionMatch) {
                    const position = parseInt(positionMatch[1]);
                    let currentPos = 0;
                    
                    for (let i = 0; i < lines.length; i++) {
                        if (currentPos + lines[i].length >= position) {
                            errorLine = i + 1;
                            errorColumn = position - currentPos + 1;
                            break;
                        }
                        currentPos += lines[i].length + 1; // +1 for newline
                    }
                }
                
                showMessage(`âŒ JSONæ ¼å¼é”™è¯¯: ${error.message}<br>å¯èƒ½ä½ç½®: ç¬¬${errorLine}è¡Œï¼Œç¬¬${errorColumn}åˆ—`, 'error');
                
                // é«˜äº®é”™è¯¯è¡Œï¼ˆå¦‚æœå¯èƒ½çš„è¯ï¼‰
                if (errorLine > 0) {
                    const lineStart = content.split('\n').slice(0, errorLine - 1).join('\n').length + (errorLine > 1 ? 1 : 0);
                    const lineEnd = lineStart + lines[errorLine - 1].length;
                    editor.focus();
                    editor.setSelectionRange(lineStart, lineEnd);
                }
            }
        }

        // JSONæ ¼å¼åŒ–åŠŸèƒ½
        function formatJson() {
            const editor = document.getElementById('configEditor');
            const content = editor.value.trim();
            
            if (!content) {
                showMessage('ç¼–è¾‘å™¨ä¸ºç©ºï¼Œè¯·å…ˆåŠ è½½é…ç½®æ–‡ä»¶', 'info');
                return;
            }
            
            try {
                const jsonObj = JSON.parse(content);
                const formattedJson = JSON.stringify(jsonObj, null, 2);
                editor.value = formattedJson;
                isModified = true;
                showMessage('âœ¨ JSONæ ¼å¼åŒ–æˆåŠŸï¼', 'success');
            } catch (error) {
                showMessage(`âŒ æ— æ³•æ ¼å¼åŒ–ï¼ŒJSONæ ¼å¼é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•ä¸­æ–‡ç¼–ç åŠŸèƒ½
        function testEncoding() {
            const editor = document.getElementById('configEditor');
            const content = editor.value.trim();
            
            if (!content) {
                showMessage('ç¼–è¾‘å™¨ä¸ºç©ºï¼Œè¯·å…ˆåŠ è½½é…ç½®æ–‡ä»¶', 'info');
                return;
            }

            // æ£€æµ‹ä¸­æ–‡å­—ç¬¦
            const chineseRegex = /[\u4e00-\u9fa5]/g;
            const chineseMatches = content.match(chineseRegex);
            
            if (chineseMatches) {
                const chineseCount = chineseMatches.length;
                const sampleChinese = [...new Set(chineseMatches)].slice(0, 10).join('');
                
                // æµ‹è¯•ç¼–ç è§£ç 
                const testString = "æµ‹è¯•ä¸­æ–‡ç¼–ç ï¼šè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•";
                const encoded = safeBase64Encode(testString);
                const decoded = safeBase64Decode(encoded);
                
                console.log('ä¸­æ–‡ç¼–ç æµ‹è¯•:', {
                    original: testString,
                    encoded: encoded,
                    decoded: decoded,
                    isCorrect: testString === decoded
                });
                
                showMessage(`ğŸ” æ£€æµ‹åˆ° ${chineseCount} ä¸ªä¸­æ–‡å­—ç¬¦<br>æ ·ä¾‹å­—ç¬¦: ${sampleChinese}<br>ç¼–ç æµ‹è¯•: ${testString === decoded ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸'}`, 'info');
            } else {
                showMessage('ğŸ” æœªæ£€æµ‹åˆ°ä¸­æ–‡å­—ç¬¦', 'info');
            }
        }

        // === äº§å“ç®¡ç†åŠŸèƒ½ ===

        // æ˜¾ç¤ºäº§å“ç®¡ç†å™¨
        function showProductManager() {
            document.getElementById('editorSection').classList.remove('active');
            document.getElementById('productManager').style.display = 'block';
            clearProductMessages();
        }

        // è·å–æ—¶é—´æˆ³
        async function getTimestamp() {
            try {
                const response = await fetch('/api/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getAuthHeader()
                    },
                    body: JSON.stringify({ action: 'getTimestamp' })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        document.getElementById('productItem').value = result.timestamp;
                        showProductMessage(`ğŸ• æ—¶é—´æˆ³ç”ŸæˆæˆåŠŸ: ${result.timestamp}<br>å¯è¯»æ—¶é—´: ${result.readable}`, 'success');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showProductMessage(`è·å–æ—¶é—´æˆ³å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ è½½äº§å“
        async function loadProduct() {
            const item = document.getElementById('productItem').value.trim();
            if (!item) {
                showProductMessage('è¯·è¾“å…¥äº§å“item', 'error');
                return;
            }

            showLoading(true);
            clearProductMessages();

            try {
                const response = await fetch('/api/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getAuthHeader()
                    },
                    body: JSON.stringify({ 
                        action: 'getProduct',
                        item: item,
                        storageType: currentStorageType
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        document.getElementById('productEditor').value = JSON.stringify(result.product, null, 2);
                        showProductMessage(`âœ… äº§å“ ${item} åŠ è½½æˆåŠŸ`, 'success');
                    } else {
                        showProductMessage(`âŒ ${result.message}`, 'error');
                    }
                } else if (response.status === 404) {
                    const result = await response.json();
                    showProductMessage(`âŒ ${result.message}`, 'error');
                    // åˆ›å»ºæ–°äº§å“æ¨¡æ¿
                    const template = {
                        "item": item,
                        "category": "",
                        "categoryLabel": "",
                        "title": "",
                        "description": "",
                        "image": "",
                        "tags": []
                    };
                    document.getElementById('productEditor').value = JSON.stringify(template, null, 2);
                    showProductMessage(`ğŸ’¡ å·²åˆ›å»ºæ–°äº§å“æ¨¡æ¿ï¼Œè¯·å¡«å†™äº§å“ä¿¡æ¯`, 'info');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showProductMessage(`åŠ è½½äº§å“å¤±è´¥: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ä¿å­˜äº§å“
        async function saveProduct() {
            const item = document.getElementById('productItem').value.trim();
            const content = document.getElementById('productEditor').value.trim();

            if (!item) {
                showProductMessage('è¯·è¾“å…¥äº§å“item', 'error');
                return;
            }

            if (!content) {
                showProductMessage('è¯·è¾“å…¥äº§å“æ•°æ®', 'error');
                return;
            }

            // éªŒè¯JSONæ ¼å¼
            let productData;
            try {
                productData = JSON.parse(content);
            } catch (error) {
                showProductMessage(`JSONæ ¼å¼é”™è¯¯: ${error.message}`, 'error');
                return;
            }

            showLoading(true);
            clearProductMessages();

            try {
                const response = await fetch('/api/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getAuthHeader()
                    },
                    body: JSON.stringify({ 
                        action: 'saveProduct',
                        item: item,
                        productData: productData,
                        storageType: currentStorageType
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showProductMessage(`âœ… ${result.message}`, 'success');
                    } else {
                        showProductMessage(`âŒ ${result.message}`, 'error');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showProductMessage(`ä¿å­˜äº§å“å¤±è´¥: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // åˆ—å‡ºæ‰€æœ‰äº§å“
        async function listProducts() {
            showLoading(true);
            clearProductMessages();

            try {
                const response = await fetch('/api/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getAuthHeader()
                    },
                    body: JSON.stringify({ 
                        action: 'listProducts',
                        storageType: currentStorageType
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        const productsDiv = document.getElementById('productsList');
                        
                        if (result.products.length === 0) {
                            productsDiv.innerHTML = `
                                <div style="text-align: center; padding: 20px; color: #666; border: 2px dashed #ddd; border-radius: 8px;">
                                    <h4>ğŸ“¦ æš‚æ— äº§å“</h4>
                                    <p>${result.message || 'è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•äº§å“æ–‡ä»¶'}</p>
                                </div>
                            `;
                        } else {
                            productsDiv.innerHTML = `
                                <h4>ğŸ“¦ äº§å“åˆ—è¡¨ (${result.products.length}ä¸ª)</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 15px;">
                                    ${result.products.map(product => `
                                        <div style="border: 1px solid #ddd; border-radius: 6px; padding: 10px; cursor: pointer; hover:background: #f5f5f5;"
                                             onclick="loadProductById('${product.item}')">
                                            <strong>${product.item}</strong><br>
                                            <small style="color: #666;">${product.name}</small>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }

                        showProductMessage(`âœ… äº§å“åˆ—è¡¨åŠ è½½æˆåŠŸ`, 'success');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showProductMessage(`è·å–äº§å“åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // é€šè¿‡IDåŠ è½½äº§å“
        function loadProductById(item) {
            document.getElementById('productItem').value = item;
            loadProduct();
        }

        // æ£€æŸ¥äº§å“JSONæ ¼å¼
        function checkProductJsonFormat() {
            const editor = document.getElementById('productEditor');
            const content = editor.value.trim();
            
            if (!content) {
                showProductMessage('ç¼–è¾‘å™¨ä¸ºç©º', 'info');
                return;
            }
            
            try {
                JSON.parse(content);
                showProductMessage('âœ… JSONæ ¼å¼æ­£ç¡®ï¼', 'success');
            } catch (error) {
                showProductMessage(`âŒ JSONæ ¼å¼é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // æ ¼å¼åŒ–äº§å“JSON
        function formatProductJson() {
            const editor = document.getElementById('productEditor');
            const content = editor.value.trim();
            
            if (!content) {
                showProductMessage('ç¼–è¾‘å™¨ä¸ºç©º', 'info');
                return;
            }
            
            try {
                const jsonObj = JSON.parse(content);
                const formattedJson = JSON.stringify(jsonObj, null, 2);
                editor.value = formattedJson;
                showProductMessage('âœ¨ JSONæ ¼å¼åŒ–æˆåŠŸï¼', 'success');
            } catch (error) {
                showProductMessage(`âŒ æ— æ³•æ ¼å¼åŒ–ï¼ŒJSONæ ¼å¼é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // è·å–è®¤è¯å¤´
        function getAuthHeader() {
            const credentials = localStorage.getItem('adminCredentials');
            if (credentials) {
                const cred = JSON.parse(credentials);
                return `Basic ${btoa(`${cred.username}:${cred.password}`)}`;
            }
            return '';
        }

        // æ˜¾ç¤ºäº§å“æ¶ˆæ¯
        function showProductMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('productMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = message;
            
            messagesDiv.appendChild(messageDiv);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤æ¶ˆæ¯
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }

        // æ¸…é™¤äº§å“æ¶ˆæ¯
        function clearProductMessages() {
            const messagesDiv = document.getElementById('productMessages');
            messagesDiv.innerHTML = '';
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = message;
            
            messagesDiv.appendChild(messageDiv);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤æ¶ˆæ¯
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }

        // æ¸…é™¤æ¶ˆæ¯
        function clearMessages() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
        }

        // æ˜¾ç¤º/éšè—åŠ è½½æŒ‡ç¤ºå™¨
        function showLoading(show) {
            const indicator = document.getElementById('loadingIndicator');
            indicator.classList.toggle('show', show);
        }

        // æ›´æ–°çŠ¶æ€
        function updateStatus(text, connected) {
            document.getElementById('statusText').textContent = text;
            const indicator = document.getElementById('statusIndicator');
            indicator.className = connected ? 'status-indicator connected' : 'status-indicator';
        }

        // ç›‘å¬ç¼–è¾‘å™¨å˜åŒ–
        document.getElementById('configEditor').addEventListener('input', function() {
            isModified = true;
        });

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 's') {
                    e.preventDefault();
                    saveConfig();
                } else if (e.key === 'r') {
                    e.preventDefault();
                    reloadConfig();
                }
            }
        });

        // å­˜å‚¨ç±»å‹åˆ‡æ¢
        function changeStorageType() {
            const storageSelect = document.getElementById('storageType');
            const newStorageType = storageSelect.value;
            
            if (isModified && !confirm('å½“å‰æœ‰æœªä¿å­˜çš„ä¿®æ”¹ï¼Œç¡®å®šè¦åˆ‡æ¢å­˜å‚¨ç±»å‹å—ï¼Ÿ')) {
                // æ¢å¤åŸå€¼
                storageSelect.value = currentStorageType;
                return;
            }
            
            currentStorageType = newStorageType;
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            if (currentStorageType === 'kv') {
                updateStatus('åˆ‡æ¢åˆ°KVå­˜å‚¨', true);
                showMessage('å·²åˆ‡æ¢åˆ°EdgeOne KVå­˜å‚¨æ¨¡å¼', 'info');
            } else {
                updateStatus('åˆ‡æ¢åˆ°Gitee', true);
                showMessage('å·²åˆ‡æ¢åˆ°Giteeä»“åº“æ¨¡å¼', 'info');
            }
            
            // å¦‚æœå½“å‰æœ‰é€‰ä¸­çš„é…ç½®ï¼Œé‡æ–°åŠ è½½
            if (currentConfigKey && currentConfigData) {
                loadConfigFromStorage(currentConfigKey);
            }
        }

        // æ˜¾ç¤ºæ•°æ®è¿ç§»é¢æ¿
        function showMigrationPanel() {
            // éšè—å…¶ä»–é¢æ¿
            document.getElementById('editorSection').classList.remove('active');
            document.getElementById('productManager').style.display = 'none';
            
            // æ˜¾ç¤ºè¿ç§»é¢æ¿
            document.getElementById('migrationPanel').style.display = 'block';
            
            // åŠ è½½å­˜å‚¨ä¿¡æ¯
            getStorageInfo();
        }

        // éšè—æ•°æ®è¿ç§»é¢æ¿
        function hideMigrationPanel() {
            document.getElementById('migrationPanel').style.display = 'none';
        }

        // è·å–å­˜å‚¨ä¿¡æ¯
        async function getStorageInfo() {
            try {
                const response = await fetch('/api/migration', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getAuthHeader()
                    },
                    body: JSON.stringify({ action: 'getStorageInfo' })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        displayStorageInfo(result.storageInfo);
                    }
                } else {
                    console.warn('è·å–å­˜å‚¨ä¿¡æ¯å¤±è´¥');
                }
            } catch (error) {
                console.error('è·å–å­˜å‚¨ä¿¡æ¯é”™è¯¯:', error);
            }
        }

        // æ˜¾ç¤ºå­˜å‚¨ä¿¡æ¯
        function displayStorageInfo(info) {
            const storageInfoDiv = document.getElementById('storageInfo');
            
            const html = `
                <h4>ğŸ“Š å­˜å‚¨çŠ¶æ€ä¿¡æ¯</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                    <div>
                        <h5>ğŸ“ Gitee ä»“åº“</h5>
                        <p>çŠ¶æ€: ${info.gitee.available ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}</p>
                    </div>
                    <div>
                        <h5>â˜ï¸ EdgeOne KV å­˜å‚¨</h5>
                        <p>é…ç½®å­˜å‚¨: ${info.kv.config ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'} ${info.kv.configCount !== undefined ? `(${info.kv.configCount}ä¸ªé…ç½®)` : ''}</p>
                        <p>äº§å“å­˜å‚¨: ${info.kv.products ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'} ${info.kv.productCount !== undefined ? `(${info.kv.productCount}ä¸ªäº§å“)` : ''}</p>
                    </div>
                </div>
            `;
            
            storageInfoDiv.innerHTML = html;
            storageInfoDiv.style.display = 'block';
        }

        // æ‰§è¡Œæ•°æ®è¿ç§»
        async function migrateData(action, dataType) {
            if (!confirm(`ç¡®å®šè¦æ‰§è¡Œ ${dataType === 'all' ? 'å…¨éƒ¨æ•°æ®' : dataType === 'configs' ? 'é…ç½®æ–‡ä»¶' : 'äº§å“æ–‡ä»¶'} çš„è¿ç§»å—ï¼Ÿ`)) {
                return;
            }

            showLoading(true);
            clearMigrationMessages();

            try {
                const response = await fetch('/api/migration', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': getAuthHeader()
                    },
                    body: JSON.stringify({ 
                        action: action,
                        dataType: dataType
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showMigrationMessage(`âœ… ${result.message}`, 'success');
                        
                        // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
                        if (result.results) {
                            let detailHtml = '<h5>è¿ç§»è¯¦æƒ…:</h5>';
                            
                            if (result.results.configs && result.results.configs.length > 0) {
                                detailHtml += '<p><strong>é…ç½®æ–‡ä»¶:</strong></p><ul>';
                                result.results.configs.forEach(item => {
                                    detailHtml += `<li>${item.type || item.item}: ${item.status === 'success' ? 'âœ…' : 'âŒ'} ${item.error || ''}</li>`;
                                });
                                detailHtml += '</ul>';
                            }
                            
                            if (result.results.products && result.results.products.length > 0) {
                                detailHtml += '<p><strong>äº§å“æ–‡ä»¶:</strong></p><ul>';
                                result.results.products.forEach(item => {
                                    detailHtml += `<li>${item.item}: ${item.status === 'success' ? 'âœ…' : 'âŒ'} ${item.error || ''}</li>`;
                                });
                                detailHtml += '</ul>';
                            }
                            
                            if (result.results.errors && result.results.errors.length > 0) {
                                detailHtml += '<p><strong>é”™è¯¯:</strong></p><ul>';
                                result.results.errors.forEach(error => {
                                    detailHtml += `<li>${error.type}: ${error.error}</li>`;
                                });
                                detailHtml += '</ul>';
                            }
                            
                            showMigrationMessage(detailHtml, 'info');
                        }
                        
                        // æ›´æ–°å­˜å‚¨ä¿¡æ¯
                        setTimeout(() => {
                            getStorageInfo();
                        }, 1000);
                    } else {
                        showMigrationMessage(`âŒ ${result.error || result.message}`, 'error');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showMigrationMessage(`è¿ç§»å¤±è´¥: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // æ˜¾ç¤ºè¿ç§»æ¶ˆæ¯
        function showMigrationMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('migrationMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = message;
            
            messagesDiv.appendChild(messageDiv);
            
            // 5ç§’åè‡ªåŠ¨ç§»é™¤æ¶ˆæ¯
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }

        // æ¸…é™¤è¿ç§»æ¶ˆæ¯
        function clearMigrationMessages() {
            const messagesDiv = document.getElementById('migrationMessages');
            messagesDiv.innerHTML = '';
        }

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>